<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Ø¨Ø§Ø²ÛŒ Ù†Ù‚Ø·Ù‡â€ŒØ®Ø· Ù…Ù‡ÛŒØ§Ø± Ùˆ Ø¢Ø±Ø§Ù…</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    body { font-family: sans-serif; background: #ffe6f0; text-align: center; direction: rtl; }
    h1 { color: #ff4d88; }
    .hidden { display: none; }
    #board { display: grid; justify-content: center; margin-top: 20px; }
    .dot { width: 15px; height: 15px; background: #ff4d88; border-radius: 50%; }
    .h-line, .v-line { background: transparent; cursor: pointer; }
    .h-line { height: 4px; width: 50px; }
    .v-line { width: 4px; height: 50px; }
    .line-active { background: #ff4d88; }
    .box { width: 50px; height: 50px; background: white; }
    #controls button { margin: 10px; padding: 10px; background: #ff4d88; color: white; border: none; border-radius: 5px; cursor: pointer; }
</style>
</head>
<body>

<h1>ğŸ’– Ø¢Ø±Ø§Ù… Ùˆ Ù…Ù‡ÛŒØ§Ø± ğŸ’–</h1>

<div id="login">
    <p>Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† Ú©Ø¯ÙˆÙ… Ø¨Ø§Ø²ÛŒÚ©Ù†ÛŒ:</p>
    <button onclick="selectPlayer('Ù…Ù‡ÛŒØ§Ø±')">Ù…Ù‡ÛŒØ§Ø±</button>
    <button onclick="selectPlayer('Ø¢Ø±Ø§Ù…')">Ø¢Ø±Ø§Ù…</button>
</div>

<div id="waiting" class="hidden">
    <h2>â³ Ù…Ù†ØªØ¸Ø± Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¯ÛŒÚ¯Ø±...</h2>
</div>

<div id="game" class="hidden">
    <h2 id="turnDisplay"></h2>
    <div id="board"></div>
    <div id="controls">
        <button onclick="restartGame()">ğŸ”„ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯</button>
        <button onclick="exitGame()">ğŸšª Ø®Ø±ÙˆØ¬</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, update, onValue, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB-7eEYJd1bfG4l1q42y_xtSQvb6AG4d1g",
  authDomain: "aram-mahyar.firebaseapp.com",
  projectId: "aram-mahyar",
  storageBucket: "aram-mahyar.firebasestorage.app",
  messagingSenderId: "27948148575",
  appId: "1:27948148575:web:b4357896d424bd0fe0b8ea",
  measurementId: "G-5LPNKQ7DD5",
  databaseURL: "https://aram-mahyar-default-rtdb.firebaseio.com/"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let playerName = "";
let boardSize = 3; 
let boardState = [];
let turn = "";

window.selectPlayer = function(name) {
    playerName = name;
    update(ref(db, "players/" + name), { online: true }).then(() => {
        document.getElementById("login").classList.add("hidden");
        document.getElementById("waiting").classList.remove("hidden");
    });

    onValue(ref(db, "players"), snapshot => {
        let players = snapshot.val() || {};
        if (players["Ù…Ù‡ÛŒØ§Ø±"]?.online && players["Ø¢Ø±Ø§Ù…"]?.online) {
            startGame();
        }
    });
};

function startGame() {
    get(ref(db, "game")).then(snapshot => {
        if (!snapshot.exists()) {
            set(ref(db, "game"), {
                board: Array((boardSize*2+1)*(boardSize*2+1)).fill(""),
                turn: "Ù…Ù‡ÛŒØ§Ø±"
            });
        }
    });

    document.getElementById("waiting").classList.add("hidden");
    document.getElementById("game").classList.remove("hidden");

    createBoard();

    onValue(ref(db, "game"), snapshot => {
        let data = snapshot.val();
        if (!data) return;
        boardState = data.board;
        turn = data.turn;
        updateBoardUI();
        document.getElementById("turnDisplay").textContent = `Ù†ÙˆØ¨Øª: ${turn}`;
    });
}

function createBoard() {
    const board = document.getElementById("board");
    board.innerHTML = "";
    board.style.gridTemplateColumns = `repeat(${boardSize*2+1}, auto)`;

    for (let r = 0; r < boardSize*2+1; r++) {
        for (let c = 0; c < boardSize*2+1; c++) {
            if (r % 2 === 0 && c % 2 === 0) {
                board.appendChild(createDot());
            } else if (r % 2 === 0 && c % 2 === 1) {
                board.appendChild(createLine(r, c));
            } else if (r % 2 === 1 && c % 2 === 0) {
                board.appendChild(createLine(r, c));
            } else {
                board.appendChild(createBox());
            }
        }
    }
}

function createDot() {
    let dot = document.createElement("div");
    dot.className = "dot";
    return dot;
}

function createLine(r, c) {
    let idx = r*(boardSize*2+1) + c;
    let line = document.createElement("div");
    line.className = (r % 2 === 0) ? "h-line" : "v-line";
    line.onclick = () => {
        if (turn !== playerName || boardState[idx] !== "") return;
        boardState[idx] = playerName;
        set(ref(db, "game"), { board: boardState, turn: turn === "Ù…Ù‡ÛŒØ§Ø±" ? "Ø¢Ø±Ø§Ù…" : "Ù…Ù‡ÛŒØ§Ø±" });
    };
    return line;
}

function createBox() {
    let box = document.createElement("div");
    box.className = "box";
    return box;
}

function updateBoardUI() {
    const cells = document.getElementById("board").children;
    for (let i = 0; i < boardState.length; i++) {
        if (boardState[i] !== "" && cells[i]) {
            cells[i].classList.add("line-active");
        }
    }
}

window.restartGame = function() {
    set(ref(db, "game"), {
        board: Array((boardSize*2+1)*(boardSize*2+1)).fill(""),
        turn: "Ù…Ù‡ÛŒØ§Ø±"
    });
};

window.exitGame = function() {
    update(ref(db, "players/" + playerName), { online: false });
    location.reload();
};
</script>

</body>
</html>
