<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>مهیار ❤️ آرام - بازی نقطه‌خط</title>
<style>
  body {
    font-family: sans-serif;
    background: #ffcce0;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 0;
    padding: 0;
  }
  h1 { margin: 20px 0 10px; color: white; }
  #playerSelect { margin: 50px 0; text-align: center; }
  #playerSelect button {
    font-size: 20px;
    padding: 10px 20px;
    margin: 10px;
    cursor: pointer;
    border-radius: 10px;
    border: none;
    background: #ff6699;
    color: white;
  }
  canvas {
    background: white;
    border-radius: 15px;
    margin-bottom: 20px;
  }
  #scoreBoard { color: white; font-size: 18px; margin-bottom: 30px; }
</style>
</head>
<body>

<h1>مهیار ❤️ آرام</h1>

<div id="playerSelect">
  <p>انتخاب بازیکن:</p>
  <button onclick="startGame('مهیار')">مهیار</button>
  <button onclick="startGame('آرام')">آرام</button>
</div>

<div id="scoreBoard" style="display:none;">
  نوبت: <span id="currentPlayer"></span> | مهیار: <span id="scoreM">0</span> | آرام: <span id="scoreA">0</span>
</div>

<canvas id="gameCanvas" width="400" height="400" style="display:none;"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let dots = [];
const dotCountX = 5;
const dotCountY = 5;
const spacing = 80;
let lines = [];
let squares = [];
let currentPlayer = '';
let score = { 'مهیار': 0, 'آرام': 0 };

function startGame(player) {
  currentPlayer = player;
  document.getElementById('playerSelect').style.display = 'none';
  document.getElementById('gameCanvas').style.display = 'block';
  document.getElementById('scoreBoard').style.display = 'block';
  document.getElementById('currentPlayer').innerText = currentPlayer;
  initDots();
  draw();
}

function initDots() {
  dots = [];
  for (let y = 0; y < dotCountY; y++) {
    for (let x = 0; x < dotCountX; x++) {
      dots.push({ x: 50 + x*spacing, y: 50 + y*spacing });
    }
  }
}

function drawDots() {
  ctx.fillStyle = 'black';
  dots.forEach(dot => {
    ctx.beginPath();
    ctx.arc(dot.x, dot.y, 8, 0, 2*Math.PI);
    ctx.fill();
  });
}

function drawLines() {
  ctx.strokeStyle = 'pink';
  ctx.lineWidth = 5;
  lines.forEach(l => {
    ctx.beginPath();
    ctx.moveTo(l.x1, l.y1);
    ctx.lineTo(l.x2, l.y2);
    ctx.stroke();
  });
}

function drawSquares() {
  ctx.fillStyle = 'rgba(255,102,153,0.3)';
  squares.forEach(s => {
    ctx.fillRect(s.x, s.y, spacing, spacing);
  });
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawSquares();
  drawLines();
  drawDots();
}

canvas.addEventListener('click', e => {
  const rect = canvas.getBoundingClientRect();
  const clickX = e.clientX - rect.left;
  const clickY = e.clientY - rect.top;

  // پیدا کردن نزدیک‌ترین خط ممکن
  let addedLine = false;
  for (let i = 0; i < dots.length; i++) {
    for (let j = i+1; j < dots.length; j++) {
      const d1 = dots[i];
      const d2 = dots[j];
      if ((d1.x === d2.x && Math.abs(d1.y - d2.y) === spacing) ||
          (d1.y === d2.y && Math.abs(d1.x - d2.x) === spacing)) {
        if (!lines.some(l => (l.x1===d1.x && l.y1===d1.y && l.x2===d2.x && l.y2===d2.y) ||
                             (l.x1===d2.x && l.y1===d2.y && l.x2===d1.x && l.y2===d1.y))) {
          const dist = pointLineDistance(clickX, clickY, d1.x, d1.y, d2.x, d2.y);
          if (dist < 15) {
            lines.push({ x1:d1.x, y1:d1.y, x2:d2.x, y2:d2.y, player: currentPlayer });
            addedLine = true;
            break;
          }
        }
      }
    }
    if (addedLine) break;
  }
  if (addedLine) {
    let squareCompleted = checkSquares();
    if (!squareCompleted) togglePlayer();
    updateScoreBoard();
    draw();
  }
});

function pointLineDistance(px, py, x1, y1, x2, y2) {
  const A = px - x1;
  const B = py - y1;
  const C = x2 - x1;
  const D = y2 - y1;
  const dot = A*C + B*D;
  const len_sq = C*C + D*D;
  const param = len_sq !== 0 ? dot / len_sq : -1;
  let xx, yy;
  if (param < 0) { xx = x1; yy = y1; }
  else if (param > 1) { xx = x2; yy = y2; }
  else { xx = x1 + param*C; yy = y1 + param*D; }
  const dx = px - xx;
  const dy = py - yy;
  return Math.sqrt(dx*dx + dy*dy);
}

function checkSquares() {
  let completed = false;
  for (let y = 0; y < dotCountY-1; y++) {
    for (let x = 0; x < dotCountX-1; x++) {
      const xPos = 50 + x*spacing;
      const yPos = 50 + y*spacing;
      const top = lines.some(l => lineMatches(l, xPos, yPos, xPos+spacing, yPos));
      const bottom = lines.some(l => lineMatches(l, xPos, yPos+spacing, xPos+spacing, yPos+spacing));
      const left = lines.some(l => lineMatches(l, xPos, yPos, xPos, yPos+spacing));
      const right = lines.some(l => lineMatches(l, xPos+spacing, yPos, xPos+spacing, yPos+spacing));
      if (top && bottom && left && right && !squares.some(s => s.x===xPos && s.y===yPos)) {
        squares.push({x:xPos, y:yPos, player: currentPlayer});
        score[currentPlayer]++;
        completed = true;
      }
    }
  }
  return completed;
}

function lineMatches(l, x1, y1, x2, y2) {
  return (l.x1===x1 && l.y1===y1 && l.x2===x2 && l.y2===y2) ||
         (l.x1===x2 && l.y1===y2 && l.x2===x1 && l.y2===y1);
}

function togglePlayer() {
  currentPlayer = currentPlayer==='مهیار' ? 'آرام' : 'مهیار';
}

function updateScoreBoard() {
  document.getElementById('scoreM').innerText = score['مهیار'];
  document.getElementById('scoreA').innerText = score['آرام'];
  document.getElementById('currentPlayer').innerText = currentPlayer;
}
</script>

</body>
</html>
